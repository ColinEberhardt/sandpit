"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.Vector=exports.Color=exports.Mathematics=exports.Is=undefined;var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _dat=require("dat.gui/build/dat.gui");var _dat2=_interopRequireDefault(_dat);var _queryfetch=require("queryfetch");var _queryfetch2=_interopRequireDefault(_queryfetch);var _debounce=require("debounce");var _debounce2=_interopRequireDefault(_debounce);var _seedrandom=require("seedrandom");var _seedrandom2=_interopRequireDefault(_seedrandom);var _logger=require("./utils/logger");var _logger2=_interopRequireDefault(_logger);var _Is=require("./utils/Is");var _Is2=_interopRequireDefault(_Is);var _Color=require("./utils/Color");var _Color2=_interopRequireDefault(_Color);var _Mathematics=require("./utils/Mathematics");var _Mathematics2=_interopRequireDefault(_Mathematics);var _Vector=require("./utils/Vector");var _Vector2=_interopRequireDefault(_Vector);require("whatwg-fetch");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Sandpit=function(){_createClass(Sandpit,null,[{key:"CANVAS",get:function get(){return"2d"}},{key:"WEBGL",get:function get(){return"webgl"}},{key:"EXPERIMENTAL_WEBGL",get:function get(){return"experimental-webgl"}}]);function Sandpit(container,type){var retina=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;_classCallCheck(this,Sandpit);_logger2.default.info("â›± Welcome to Sandpit");this._setupContext(container,type,retina)}_createClass(Sandpit,[{key:"_setupContext",value:function _setupContext(container,type,retina){if(typeof container!=="string"&&(typeof container==="undefined"?"undefined":_typeof(container))!=="object"){throw new Error('Please provide a string or object reference to the container, like ".container", or document.querySelector(".container")')}if(typeof type!=="string"||type!==Sandpit.CANVAS&&type!==Sandpit.WEBGL){throw new Error("Please provide a context type - either `Sandpit.CANVAS` or `Sandpit.WEBGL`")}var _container=void 0;if(typeof container==="string"){_container=document.querySelector(container)}else if((typeof container==="undefined"?"undefined":_typeof(container))==="object"){_container=container}if(_Is2.default.element(_container)){if(_Is2.default.canvas(_container)){this._canvas=_container}else{this._canvas=document.createElement("canvas");_container.appendChild(this._canvas)}this._canvas.width=this._canvas.clientWidth;this._canvas.height=this._canvas.clientHeight;if(type===Sandpit.CANVAS){this._context=this._canvas.getContext(type)}else if(type===Sandpit.WEBGL||type===Sandpit.EXPERIMENTAL_WEBGL){this._context=this._canvas.getContext(Sandpit.WEBGL)||this._canvas.getContext(Sandpit.EXPERIMENTAL_WEBGL)}this._type=type;if(type===Sandpit.CANVAS&&window.devicePixelRatio!==1&&retina){var ratio=window.devicePixelRatio;this._canvas.width=this._canvas.width*ratio;this._canvas.height=this._canvas.height*ratio;this._canvas.style.width=this._canvas.clientWidth+"px";this._canvas.style.height=this._canvas.clientHeight+"px";if(this._context)this._context.scale(ratio,ratio)}}else{throw new Error("The container is not a HTMLElement")}}},{key:"_setupSettings",value:function _setupSettings(){var _this=this;this.settings={};this._gui=new _dat2.default.GUI;this._gui.domElement.addEventListener("touchmove",this._preventDefault,false);if(this._queryable){if(window.location.search){(function(){var params=_queryfetch2.default.parse(window.location.search);Object.keys(params).forEach(function(key){if(_this.defaults[key]){var param=params[key];if(param==="true")param=true;if(param==="false")param=false;if(_typeof(_this.defaults[key].value)!=="object"){if(!_this.defaults[key].sticky){_this.defaults[key].value=param}}else{if(!_this.defaults[key].sticky){_this.defaults[key].selected=param}else{_this.defaults[key].selected=_this.defaults[key].value[Object.keys(_this.defaults[key].value)[0]]}}}})})()}}var group=this._gui.addFolder("Settings");Object.keys(this.defaults).forEach(function(name){var options=false;var value=_this.defaults[name].value;if((typeof value==="undefined"?"undefined":_typeof(value))==="object"){options=value;if(_this.defaults[name].selected){_this.settings[name]=_this.defaults[name].selected}else{_this.settings[name]=_Is2.default.array(value)?value[0]:value[Object.keys(value)[0]]}}else{_this.settings[name]=_this.defaults[name].value}var guiField=_this.defaults[name].color?group.addColor(_this.settings,name):group.add(_this.settings,name,options);if(_this.defaults[name].min!==undefined)guiField=guiField.min(_this.defaults[name].min);if(_this.defaults[name].max!==undefined)guiField=guiField.max(_this.defaults[name].max);if(_this.defaults[name].step!==undefined)guiField=guiField.step(_this.defaults[name].step);if(_this.defaults[name].editable===false){guiField.domElement.style.pointerEvents="none";guiField.domElement.style.opacity=.5}guiField.onChange((0,_debounce2.default)(function(value){_this._change(name,value)}),300)});group.open();if(this.width()<=767){this._gui.close()}if(this._queryable){var query=_queryfetch2.default.serialize(this.settings);window.history.replaceState({},null,"/?"+query);this._gui.add({clear:function clear(){_this.clear()}},"clear");this._gui.add({reset:function reset(){_this._reset()}},"reset")}}},{key:"_reset",value:function _reset(){if(this._queryable||this.reset){if(this.reset){this.reset()}else{window.history.replaceState({},null,"/");window.location.reload()}}}},{key:"_change",value:function _change(name,value){_logger2.default.info("Update fired on "+name+": "+value);if(this._queryable){var query=_queryfetch2.default.serialize(this.settings);window.history.pushState({},null,"/?"+query)}if(this.change){this.change(name,value)}}},{key:"_setupLoop",value:function _setupLoop(){this._time=0;this._loop()}},{key:"_loop",value:function _loop(){if(this._autoClear)this.clear();if(this.loop)this.loop();this._time++;this._animationFrame=window.requestAnimationFrame(this._loop.bind(this))}},{key:"_setupEvents",value:function _setupEvents(){var _this2=this;this._events={};this._setupResize();this._setupInput();Object.keys(this._events).forEach(function(event){if(_this2._events[event].disable){_this2._events[event].disable.addEventListener(event,_this2._preventDefault,false)}_this2._events[event].context.addEventListener(event,_this2._events[event].event.bind(_this2),false)})}},{key:"_setupResize",value:function _setupResize(){this._resizeEvent=this.resize?this.resize:this.resizeCanvas;this._events["resize"]={event:this._resizeEvent,context:window}}},{key:"_setupMouse",value:function _setupMouse(){this._events["mousemove"]={event:this._handleMouseMove,context:document};this._events["mousedown"]={event:this._handleMouseDown,context:document};this._events["mouseenter"]={event:this._handleMouseEnter,context:document};this._events["mouseleave"]={event:this._handleMouseLeave,context:document};this._events["mouseup"]={event:this._handleMouseUp,context:document}}},{key:"_setupTouches",value:function _setupTouches(){var body=document.querySelector("body");this._events["touchmove"]={event:this._handleTouchMove,disable:document,context:body};this._events["touchstart"]={event:this._handleTouchStart,disable:document,context:body};this._events["touchend"]={event:this._handleTouchEnd,disable:document,context:body}}},{key:"_stopPropagation",value:function _stopPropagation(event){event.stopPropagation()}},{key:"_preventDefault",value:function _preventDefault(event){event.preventDefault()}},{key:"_setupAccelerometer",value:function _setupAccelerometer(){if(window.DeviceOrientationEvent){this._events["deviceorientation"]={event:this._handleAccelerometer,context:window}}else{_logger2.default.warn("Accelerometer is not supported by this device")}}},{key:"_setupInput",value:function _setupInput(){this.input={};this._setupMouse();this._setupTouches();this._setupAccelerometer()}},{key:"_handleMouseMove",value:function _handleMouseMove(event){event.touches={};event.touches[0]=event;this._handleTouches(event);if(this.move)this.move(event)}},{key:"_handleMouseDown",value:function _handleMouseDown(event){event.touches={};event.touches[0]=event;this._handleTouches(event);if(this.touch)this.touch(event)}},{key:"_handleMouseUp",value:function _handleMouseUp(event){this._handleRelease();if(this.release)this.release(event)}},{key:"_handleMouseEnter",value:function _handleMouseEnter(event){this.input.inFrame=true}},{key:"_handleMouseLeave",value:function _handleMouseLeave(event){this.input.inFrame=false}},{key:"_handleTouchMove",value:function _handleTouchMove(event){event.preventDefault();this._handleTouches(event);if(this.move)this.move(event)}},{key:"_handleTouchStart",value:function _handleTouchStart(event){this._focusTouchesOnCanvas?event.preventDefault():event.stopPropagation();this._handleTouches(event);if(this.touch)this.touch(event)}},{key:"_handleTouchEnd",value:function _handleTouchEnd(event){this._focusTouchesOnCanvas?event.preventDefault():event.stopPropagation();this._handleTouches(event);if(this.release)this.release(event)}},{key:"_handleAccelerometer",value:function _handleAccelerometer(event){if(event.beta&&event.alpha&&event.gamma){this.input.accelerometer={xAxis:event.beta,yAxis:event.gamma,rotation:event.alpha,gamma:event.gamma,beta:event.beta,alpha:event.alpha}}if(this.accelerometer)this.accelerometer(event)}},{key:"_handleTouches",value:function _handleTouches(event){var _this3=this;delete event.touches.length;if(Object.keys(event.touches).length){var touches=Object.keys(event.touches).map(function(key,i){if(i===0){_this3.input.x=event.touches[key].pageX;_this3.input.y=event.touches[key].pageY}var touch={};if(_this3.input.touches&&_this3.input.touches[key]){touch.previousX=_this3.input.touches[key].x;touch.previousY=_this3.input.touches[key].y}touch.x=event.touches[key].pageX;touch.y=event.touches[key].pageY;if(event.touches[key].force)touch.force=event.touches[key].force;return touch});this.input.touches=touches}else{this._handleRelease()}}},{key:"_handleRelease",value:function _handleRelease(){delete this.input.x;delete this.input.y;delete this.input.touches}},{key:"settings",value:function settings(_settings){var queryable=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;this.defaults=_settings;this._queryable=queryable}},{key:"debug",value:function debug(boolean){_logger2.default.active=boolean}},{key:"autoClear",value:function autoClear(boolean){this._autoClear=boolean}},{key:"clear",value:function clear(){if(this._type===Sandpit.CANVAS){this._context.clearRect(0,0,this.width(),this.height())}else if(this._type===Sandpit.WEBGL||this._type===Sandpit.EXPERIMENTAL_WEBGL){this._context.clearColor(0,0,0,0);this._context.clear(this._context.COLOR_BUFFER_BIT|this._context.DEPTH_BUFFER_BIT)}}},{key:"clearQueryString",value:function clearQueryString(){window.history.replaceState({},null,"/")}},{key:"focusTouchesOnCanvas",value:function focusTouchesOnCanvas(boolean){this._focusTouchesOnCanvas=boolean}},{key:"context",value:function context(){return this._context}},{key:"canvas",value:function canvas(){return this._canvas}},{key:"time",value:function time(){return this._time}},{key:"width",value:function width(){return this._canvas.clientWidth}},{key:"height",value:function height(){return this._canvas.clientHeight}},{key:"fill",value:function fill(color){if(this._type===Sandpit.CANVAS){this._context.fillStyle=color;this._context.fillRect(0,0,this.width(),this.height())}else if(this._type===Sandpit.WEBGL||this._type===Sandpit.EXPERIMENTAL_WEBGL){_logger2.default.warn("fill() is currently only supported in 2D")}}},{key:"get",value:function get(url){return new Promise(function(resolve,reject){fetch(url).then(function(response){resolve(response.text())}).catch(function(error){_logger2.default.info("Get fail",error);reject()})})}},{key:"random",value:function random(){var seed=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"123456";return(0,_seedrandom2.default)(seed)}},{key:"resizeCanvas",value:function resizeCanvas(){this._canvas.width=this._canvas.clientWidth;this._canvas.height=this._canvas.clientHeight;if(this._type===Sandpit.WEBGL||this._type===Sandpit.EXPERIMENTAL_WEBGL){this._context.viewport(0,0,this._context.drawingBufferWidth,this._context.drawingBufferHeight)}}},{key:"start",value:function start(){if(this.defaults&&Object.keys(this.defaults).length)this._setupSettings();this._setupEvents();if(this.setup)this.setup();if(!this.loop)_logger2.default.warn("Looks like you need to define a loop");this._setupLoop()}},{key:"stop",value:function stop(){var _this4=this;window.cancelAnimationFrame(this._animationFrame);if(this.canvas()){this.canvas().outerHTML="";delete this.canvas()}if(this._gui){this._gui.domElement.removeEventListener("touchmove",this._preventDefault);this._gui.destroy()}Object.keys(this._events).forEach(function(event){if(_this4._events[event].disable){_this4._events[event].disable.removeEventListener(event,_this4._preventDefault)}_this4._events[event].context.removeEventListener(event,_this4._events[event].event.bind(_this4))})}}]);return Sandpit}();exports.Is=_Is2.default;exports.Mathematics=_Mathematics2.default;exports.Color=_Color2.default;exports.Vector=_Vector2.default;exports.default=Sandpit;